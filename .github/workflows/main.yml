name: Build and Upload Lambda Zip

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -t .

      - name: Clean up unnecessary files
        run: |
          rm -rf __pycache__ \
                 .pytest_cache \
                 *.dist-info/INSTALLER \
                 *.dist-info/RECORD \
                 .github \
                 build_lambda.sh \
                 create_layer.sh \
                 README.md

      - name: Create Lambda deployment package
        run: |
          zip -r mcp-server-time-lambda.zip . -x "*.git*" "*.pyc" "__pycache__/*"

      - name: Generate version tag
        id: version
        run: |
          if [[ ${{ github.ref }} == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v$(date +'%Y%m%d-%H%M%S')-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: MCP Time Server ${{ steps.version.outputs.version }}
          body: |
            ğŸ• **MCP Time Server Lambda ë°°í¬ íŒ¨í‚¤ì§€**
            
            ## ğŸ“¦ ì‚¬ìš©ë²•
            1. ì•„ë˜ `mcp-server-time-lambda.zip` ë‹¤ìš´ë¡œë“œ
            2. AWS Lambda í•¨ìˆ˜ì— ì—…ë¡œë“œ
            3. Handler: `mcp_server_time_lambda.handler`
            4. Runtime: `python3.13`
            5. Timeout: 30ì´ˆ ì´ìƒ ê¶Œì¥
            
            ## ğŸ”§ ì œê³µ ê¸°ëŠ¥
            - `get_current_time`: í˜„ì¬ ì‹œê°„ ì¡°íšŒ (íƒ€ì„ì¡´ ì§€ì›)
            - `convert_time`: ì‹œê°„ëŒ€ ë³€í™˜
            
            ## ğŸ“ ë³€ê²½ì‚¬í•­
            - ì»¤ë°‹: ${{ github.sha }}
            - ë¹Œë“œ ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S UTC')
          files: |
            mcp-server-time-lambda.zip
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/v') }}
