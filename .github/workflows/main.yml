name: Build and Upload Lambda Zip

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:  # 수동 실행 가능

jobs:
  build-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -t .

      - name: Clean up unnecessary files
        run: |
          rm -rf __pycache__ \
                 .pytest_cache \
                 *.dist-info/INSTALLER \
                 *.dist-info/RECORD \
                 .github \
                 build_lambda.sh \
                 create_layer.sh \
                 README.md

      - name: Create Lambda deployment package
        run: |
          zip -r mcp-server-time-lambda.zip . -x "*.git*" "*.pyc" "__pycache__/*"

      - name: Generate version tag
        id: version
        run: |
          if [[ ${{ github.ref }} == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v$(date +'%Y%m%d-%H%M%S')-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: MCP Time Server ${{ steps.version.outputs.version }}
          body: |
            🕐 **MCP Time Server Lambda 배포 패키지**
            
            ## 📦 사용법
            1. 아래 `mcp-server-time-lambda.zip` 다운로드
            2. AWS Lambda 함수에 업로드
            3. Handler: `mcp_server_time_lambda.handler`
            4. Runtime: `python3.13`
            5. Timeout: 30초 이상 권장
            
            ## 🔧 제공 기능
            - `get_current_time`: 현재 시간 조회 (타임존 지원)
            - `convert_time`: 시간대 변환
            
            ## 📝 변경사항
            - 커밋: ${{ github.sha }}
            - 빌드 시간: $(date +'%Y-%m-%d %H:%M:%S UTC')
          files: |
            mcp-server-time-lambda.zip
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/v') }}
